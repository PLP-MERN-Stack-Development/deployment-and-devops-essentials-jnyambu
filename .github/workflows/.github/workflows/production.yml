name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: false

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get version
      id: version
      run: |
        if [ -z "${{ github.event.inputs.version }}" ]; then
          VERSION=$(date +%Y.%m.%d)-${GITHUB_SHA::7}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Create Git Tag
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git tag -a v${{ steps.version.outputs.version }} -m "Release v${{ steps.version.outputs.version }}"
        git push origin v${{ steps.version.outputs.version }}

  deploy-backend-production:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    needs: create-release
    environment:
      name: production-backend
      url: https://api-mern.onrender.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Create deployment backup point
      run: |
        echo "BACKUP_VERSION=${{ needs.create-release.outputs.version }}" >> $GITHUB_ENV
        echo "BACKUP_TIMESTAMP=$(date +%s)" >> $GITHUB_ENV

    - name: Deploy to Render (Production)
      id: deploy
      run: |
        curl -X POST ${{ secrets.RENDER_BACKEND_PROD_DEPLOY_HOOK }}

    - name: Wait for deployment
      run: sleep 90

    - name: Health check
      id: health_check
      run: |
        for i in {1..5}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PROD_BACKEND_URL }}/health)
          if [ $response -eq 200 ]; then
            echo "Health check passed on attempt $i"
            exit 0
          fi
          echo "Health check failed on attempt $i, retrying..."
          sleep 10
        done
        echo "Health check failed after 5 attempts"
        exit 1

    - name: Run production smoke tests
      run: |
        npx newman run backend/tests/postman-collection.json \
          --environment backend/tests/production-environment.json \
          --bail

    - name: Rollback on failure
      if: failure()
      run: |
        echo "Deployment failed, initiating rollback..."
        curl -X POST "${{ secrets.RENDER_BACKEND_PROD_DEPLOY_HOOK }}&rollback=true"

  deploy-frontend-production:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    needs: [create-release, deploy-backend-production]
    environment:
      name: production-frontend
      url: https://mern-app.onrender.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Render (Production)
      run: |
        curl -X POST ${{ secrets.RENDER_FRONTEND_PROD_DEPLOY_HOOK }}

    - name: Wait for deployment
      run: sleep 90

    - name: Verify deployment
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PROD_FRONTEND_URL }})
        if [ $response -ne 200 ]; then
          echo "Frontend verification failed"
          exit 1
        fi

    - name: Rollback on failure
      if: failure()
      run: |
        echo "Frontend deployment failed, initiating rollback..."
        curl -X POST "${{ secrets.RENDER_FRONTEND_PROD_DEPLOY_HOOK }}&rollback=true"

  post-deployment:
    name: Post Deployment Tasks
    runs-on: ubuntu-latest
    needs: [create-release, deploy-backend-production, deploy-frontend-production]

    steps:
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.create-release.outputs.version }}
        release_name: Release v${{ needs.create-release.outputs.version }}
        body: |
          Production deployment v${{ needs.create-release.outputs.version }}
          
          Changes in this release:
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false

    - name: Notify team
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'ðŸš€ Production deployment v${{ needs.create-release.outputs.version }} completed!'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}