name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-backend-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging-backend
      url: https://staging-api-mern.onrender.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Render (Staging)
      run: |
        curl -X POST ${{ secrets.RENDER_BACKEND_STAGING_DEPLOY_HOOK }}

    - name: Wait for deployment
      run: sleep 60

    - name: Health check
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_BACKEND_URL }}/health)
        if [ $response -ne 200 ]; then
          echo "Health check failed with status $response"
          exit 1
        fi
        echo "Health check passed"

    - name: Run smoke tests
      run: |
        npx newman run backend/tests/postman-collection.json \
          --environment backend/tests/staging-environment.json \
          --bail
      continue-on-error: false

  deploy-frontend-staging:
    name: Deploy Frontend to Staging
    runs-on: ubuntu-latest
    needs: deploy-backend-staging
    environment:
      name: staging-frontend
      url: https://staging-mern.onrender.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Render (Staging)
      run: |
        curl -X POST ${{ secrets.RENDER_FRONTEND_STAGING_DEPLOY_HOOK }}

    - name: Wait for deployment
      run: sleep 60

    - name: Verify deployment
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_FRONTEND_URL }})
        if [ $response -ne 200 ]; then
          echo "Frontend verification failed"
          exit 1
        fi

  notify-staging:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, deploy-frontend-staging]
    if: always()

    steps:
    - name: Send Slack notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Staging deployment ${{ job.status }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()